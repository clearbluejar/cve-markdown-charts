import json
import xmltodict
import os

# download https://cwe.mitre.org/data/xml/cwec_latest.xml.zip and unzip for CI
CWE_JSON_PATH = os.path.join(os.path.dirname(__file__),'cwe.json')

# from https://techoverflow.net/2018/01/16/downloading-reading-a-zip-file-in-memory-using-python/
import requests
import io
import zipfile

def download_extract_zip(url):
    """
    Download a ZIP file and extract its contents in memory
    yields (filename, file-like object) pairs
    """
    response = requests.get(url)
    with zipfile.ZipFile(io.BytesIO(response.content)) as thezip:
        for zipinfo in thezip.infolist():
            with thezip.open(zipinfo) as thefile:
                yield zipinfo.filename, thefile


def build_cwe_json():
    cwes_d = {}

    cwe_xml_zip = download_extract_zip("https://cwe.mitre.org/data/xml/cwec_latest.xml.zip")

    for name,data in cwe_xml_zip:
        if name == 'cwec_v4.7.xml':
            cwe_xml_data = data.read()

    dict_from_xml = xmltodict.parse(cwe_xml_data)

    for weak in dict_from_xml['Weakness_Catalog']['Weaknesses']['Weakness']:
        # cwes.append([weak['@ID'],weak['@Name'],'Weakness'])
        cwes_d[weak['@ID']] = {'Name': weak['@Name'], 'Type': 'Weakness'}

    for cat in dict_from_xml['Weakness_Catalog']['Categories']['Category']:
        # cwes.append([cat['@ID'],cat['@Name'],'Category'])
        cwes_d[cat['@ID']] = {'Name': cat['@Name'], 'Type': 'Category'}

    for view in dict_from_xml['Weakness_Catalog']['Views']['View']:
        # cwes.append([view['@ID'],view['@Name'],'View'])
        cwes_d[view['@ID']] = {'Name': view['@Name'], 'Type': 'View'}


    with open(CWE_JSON_PATH, 'w') as f:
        json.dump(cwes_d, f)


def get_cwe_json():

    try:
        with open(CWE_JSON_PATH) as f:
            return json.load(f)
    except FileNotFoundError as e:
        raise Exception("Missing {}. Please run {}".format(
            CWE_JSON_PATH, __file__)) from e

if __name__ == "__main__":
    build_cwe_json()